# Auto-deploy to Dokku on push
name: Deploy

on:
  workflow_dispatch:
  push:
    branches: [main, staging, develop]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'production' || github.ref_name == 'staging' && 'staging' || 'development' }}
    env:
      BASE_APP_NAME: ${{ github.event.repository.name }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set variables
        id: vars
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          case "$BRANCH" in
            main)    APP="${BASE_APP_NAME}"; ENV="production" ;;
            staging) APP="${BASE_APP_NAME}-staging"; ENV="staging" ;;
            develop) APP="${BASE_APP_NAME}-dev"; ENV="development" ;;
            *)       APP="${BASE_APP_NAME}"; ENV="production" ;;
          esac
          echo "app_name=$APP" >> $GITHUB_OUTPUT
          echo "environment=$ENV" >> $GITHUB_OUTPUT

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          echo "${{ secrets.DOKKU_SSH_PRIVATE_KEY }}" > ~/.ssh/key && chmod 600 ~/.ssh/key
          ssh-keyscan -H ${{ secrets.DOKKU_HOST }} >> ~/.ssh/known_hosts
          echo -e "Host dokku\n  HostName ${{ secrets.DOKKU_HOST }}\n  User dokku\n  IdentityFile ~/.ssh/key" > ~/.ssh/config

      - name: Create app
        run: |
          APP_NAME="${{ steps.vars.outputs.app_name }}"
          ssh dokku apps:exists $APP_NAME 2>/dev/null || ssh dokku apps:create $APP_NAME

      - name: Unlock app
        run: |
          APP_NAME="${{ steps.vars.outputs.app_name }}"
          ssh dokku apps:unlock $APP_NAME 2>/dev/null || true

      - name: Configure env
        run: |
          APP_NAME="${{ steps.vars.outputs.app_name }}"
          DOMAIN="${APP_NAME}.${{ secrets.BASE_DOMAIN }}"
          ssh dokku config:set --no-restart $APP_NAME \
            APP_ENV="${{ steps.vars.outputs.environment }}" \
            APP_URL="https://${DOMAIN}"

      - name: Deploy
        run: |
          APP_NAME="${{ steps.vars.outputs.app_name }}"
          git remote add dokku dokku@${{ secrets.DOKKU_HOST }}:$APP_NAME 2>/dev/null || true
          GIT_SSH_COMMAND="ssh -i ~/.ssh/key" git push dokku HEAD:main -f

      - name: Configure domain
        run: |
          APP_NAME="${{ steps.vars.outputs.app_name }}"
          DOMAIN="${APP_NAME}.${{ secrets.BASE_DOMAIN }}"
          ssh dokku domains:clear $APP_NAME 2>/dev/null || true
          ssh dokku domains:add $APP_NAME $DOMAIN

      - name: SSL
        run: |
          APP_NAME="${{ steps.vars.outputs.app_name }}"
          echo "Checking SSL status..."
          SSL_STATUS=$(ssh dokku letsencrypt:active $APP_NAME 2>/dev/null || echo "error")
          echo "SSL status: $SSL_STATUS"
          if [ "$SSL_STATUS" = "true" ]; then
            echo "SSL already active"
          else
            echo "Enabling SSL..."
            ssh dokku letsencrypt:enable $APP_NAME 2>&1 || echo "SSL enable failed"
          fi

      - name: Verify
        id: verify
        run: |
          APP_NAME="${{ steps.vars.outputs.app_name }}"
          DOMAIN="${APP_NAME}.${{ secrets.BASE_DOMAIN }}"
          sleep 10
          if curl -sf "https://${DOMAIN}/health"; then
            echo "HTTPS OK: https://${DOMAIN}"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "url=https://${DOMAIN}" >> $GITHUB_OUTPUT
          elif curl -sf "http://${DOMAIN}/health"; then
            echo "HTTP only: http://${DOMAIN}"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "url=http://${DOMAIN}" >> $GITHUB_OUTPUT
          else
            echo "Check logs"
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          [ -z "$SLACK_WEBHOOK_URL" ] && exit 0
          APP_NAME="${{ steps.vars.outputs.app_name }}"
          DOMAIN="${APP_NAME}.${{ secrets.BASE_DOMAIN }}"
          if [ "${{ steps.verify.outputs.status }}" == "success" ]; then
            COLOR="good"
            STATUS="✅ Deployed"
          else
            COLOR="danger"
            STATUS="❌ Deploy failed"
          fi
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$STATUS: $APP_NAME\",
                \"fields\": [
                  {\"title\": \"Environment\", \"value\": \"${{ steps.vars.outputs.environment }}\", \"short\": true},
                  {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                  {\"title\": \"URL\", \"value\": \"https://$DOMAIN\", \"short\": false}
                ],
                \"footer\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>\"
              }]
            }" \
            "$SLACK_WEBHOOK_URL" || true
