# Preview environments for pull requests
name: Preview

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

concurrency:
  group: preview-${{ github.event.pull_request.number }}

env:
  APP_NAME: ${{ github.event.repository.name }}-pr-${{ github.event.pull_request.number }}

jobs:
  deploy:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    environment: preview
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          echo "${{ secrets.DOKKU_SSH_PRIVATE_KEY }}" > ~/.ssh/key && chmod 600 ~/.ssh/key
          ssh-keyscan -H ${{ secrets.DOKKU_HOST }} >> ~/.ssh/known_hosts

      - name: Create app
        run: |
          ssh -i ~/.ssh/key dokku@${{ secrets.DOKKU_HOST }} apps:exists $APP_NAME 2>/dev/null || \
            ssh -i ~/.ssh/key dokku@${{ secrets.DOKKU_HOST }} apps:create $APP_NAME

      - name: Configure env
        run: |
          DOMAIN="${{ env.APP_NAME }}.${{ secrets.BASE_DOMAIN }}"
          ssh -i ~/.ssh/key dokku@${{ secrets.DOKKU_HOST }} config:set --no-restart $APP_NAME \
            APP_ENV=preview \
            APP_URL="https://$DOMAIN"
          ssh -i ~/.ssh/key dokku@${{ secrets.DOKKU_HOST }} resource:limit $APP_NAME --memory 256m || true

      - name: Deploy
        run: |
          git remote add dokku dokku@${{ secrets.DOKKU_HOST }}:$APP_NAME 2>/dev/null || true
          GIT_SSH_COMMAND="ssh -i ~/.ssh/key" git push dokku HEAD:main -f

      - name: Configure domain
        run: |
          DOMAIN="${{ env.APP_NAME }}.${{ secrets.BASE_DOMAIN }}"
          ssh -i ~/.ssh/key dokku@${{ secrets.DOKKU_HOST }} domains:clear $APP_NAME 2>/dev/null || true
          ssh -i ~/.ssh/key dokku@${{ secrets.DOKKU_HOST }} domains:add $APP_NAME $DOMAIN

      - name: SSL
        run: |
          ssh -i ~/.ssh/key dokku@${{ secrets.DOKKU_HOST }} letsencrypt:enable $APP_NAME || true

      - name: Comment URL
        uses: actions/github-script@v7
        with:
          script: |
            const url = `https://${{ env.APP_NAME }}.${{ secrets.BASE_DOMAIN }}`;
            const body = `## ðŸš€ Preview\n\nâœ… Deployed: [${url}](${url})\n\n<sub>Auto-destroyed on PR close</sub>`;
            const comments = await github.rest.issues.listComments({owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number});
            const bot = comments.data.find(c => c.user.type === 'Bot' && c.body.includes('Preview'));
            if (bot) await github.rest.issues.updateComment({owner: context.repo.owner, repo: context.repo.repo, comment_id: bot.id, body});
            else await github.rest.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body});

  cleanup:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Destroy preview
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DOKKU_SSH_PRIVATE_KEY }}" > ~/.ssh/key && chmod 600 ~/.ssh/key
          ssh-keyscan -H ${{ secrets.DOKKU_HOST }} >> ~/.ssh/known_hosts
          ssh -i ~/.ssh/key dokku@${{ secrets.DOKKU_HOST }} apps:destroy ${{ env.APP_NAME }} --force || true
